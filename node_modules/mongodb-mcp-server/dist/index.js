#!/usr/bin/env node
import logger, { LogId } from "./common/logger.js";
import { config } from "./common/config.js";
import { StdioRunner } from "./transports/stdio.js";
import { StreamableHttpRunner } from "./transports/streamableHttp.js";
async function main() {
    const transportRunner = config.transport === "stdio" ? new StdioRunner(config) : new StreamableHttpRunner(config);
    const shutdown = () => {
        logger.info(LogId.serverCloseRequested, "server", `Server close requested`);
        transportRunner
            .close()
            .then(() => {
            logger.info(LogId.serverClosed, "server", `Server closed`);
            process.exit(0);
        })
            .catch((error) => {
            logger.error(LogId.serverCloseFailure, "server", `Error closing server: ${error}`);
            process.exit(1);
        });
    };
    process.on("SIGINT", shutdown);
    process.on("SIGABRT", shutdown);
    process.on("SIGTERM", shutdown);
    process.on("SIGQUIT", shutdown);
    try {
        await transportRunner.start();
    }
    catch (error) {
        logger.info(LogId.serverCloseRequested, "server", "Closing server");
        try {
            await transportRunner.close();
            logger.info(LogId.serverClosed, "server", "Server closed");
        }
        catch (error) {
            logger.error(LogId.serverCloseFailure, "server", `Error closing server: ${error}`);
        }
        throw error;
    }
}
main().catch((error) => {
    logger.emergency(LogId.serverStartFailure, "server", `Fatal error running server: ${error}`);
    process.exit(1);
});
//# sourceMappingURL=index.js.map